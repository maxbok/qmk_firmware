#include <stdio.h>
#include "maxbok.h"

oled_rotation_t oled_init_user(oled_rotation_t rotation) {
    if (is_keyboard_master()) {
        return OLED_ROTATION_270;
    } else {
        return OLED_ROTATION_270;//OLED_ROTATION_90;
    }
}

static void render_logo(void) {
    static const char PROGMEM logo[] = {
        // 'Star wars', 32x128px
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe1, 0x01, 0x18, 0x1c, 0x9e, 0x9f, 0x9f, 0x9f, 0x9f, 
        0x9f, 0x9f, 0x93, 0x93, 0x9a, 0x1c, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x7e, 0x7e, 0xfc, 0xfc, 0xf0, 0xc0, 0x00, 0xff, 
        0xff, 0x00, 0x80, 0xf0, 0xf8, 0xfc, 0x7e, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x01, 
        0x01, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xc0, 0x00, 
        0xa0, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xf0, 0x00, 0xf9, 0x01, 0x00, 0x00, 
        0x01, 0x00, 0x00, 0xf9, 0xf1, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xbe, 0x00, 0x3f, 0x2f, 0x0f, 0x88, 
        0x88, 0x3f, 0x3f, 0x3f, 0x1f, 0xbe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x01, 
        0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
        0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xeb, 0x8b, 0x8b, 0x8b, 0xcb, 0xeb, 0xfb, 
        0xfb, 0xeb, 0xcb, 0x8b, 0x8b, 0x8b, 0xcb, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x0f, 0x1f, 0xff, 0xff, 0xfb, 0xf9, 0xfd, 0x1c, 0x1c, 
        0x1c, 0x1c, 0xfd, 0xf9, 0xfb, 0xff, 0xff, 0x1f, 0x0f, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0x40, 0xc0, 0xc0, 
        0xc0, 0xc0, 0xc0, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x3c, 0x3f, 0x30, 0x20, 0x60, 0x60, 0x20, 0x39, 
        0x3f, 0x3f, 0x3f, 0x3f, 0x34, 0x64, 0x40, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x1f, 0x3f, 0x7f, 0x7f, 0xff, 0xff, 0xff, 0xff, 
        0xff, 0xff, 0x7f, 0x7f, 0x37, 0x23, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 
        0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };

    oled_write_raw_P(logo, sizeof(logo));
}

typedef struct report_t {
    uint8_t type;
    uint8_t size;
    uint8_t data[30];
} Report;

char host_name[12];
char time[5];
char date[10];
Report cpu_usage_report;

bool oled_task_user(void) {
    if (is_keyboard_master()) {
        oled_clear();

        oled_write_ln(host_name, false);
        oled_write_ln(time, false);
        oled_write_ln(date, false);

        // for (int i = 0; i < cpu_usage_report.size; i++) {
        //     oled_write_char((char)cpu_usage_report.data[i], false);
        //     oled_write_char(' ', false);
        // }
    } else {
        render_logo();
    }

    return false;
}

Report build_report(uint8_t *data, uint8_t length) {
    Report report;

    uint8_t type = data[0];
    uint8_t size = data[1];

    report.type = type;
    report.size = size;

    for (int i = 0; i < size; i++) {
        report.data[i] = data[2 + i];
    }

    return report;
}

void host_name_from_report(Report report) {
    memcpy(host_name, report.data, report.size);
    host_name[report.size] = '\0';
}

void date_time_from_report(Report report) {
    uint8_t hour = report.data[0];
    uint8_t minute = report.data[1];
    uint8_t day = report.data[2];
    uint8_t month = report.data[3];

    sprintf(time, "%02uh%02u", hour, minute);
    sprintf(date, "%02u/%02u/2023", day, month);
}

void cpu_usage_from_report(Report report) {
    cpu_usage_report = report;
}

void raw_hid_receive(uint8_t *data, uint8_t length) {
    if (length > 2); else { return; }

    Report report = build_report(data, length);

    switch (report.type) {
        case 0:
            host_name_from_report(report);
        case 1:
            date_time_from_report(report);
        case 2:
            cpu_usage_from_report(report);
        default:
            break;
    }
}

